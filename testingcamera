import cv2 # type: ignore
import torch # type: ignore
import numpy as np
from torchvision import models, transforms # type: ignore
from collections import deque

# ----------------------------
# Load pre-trained Faster R-CNN
# ----------------------------
print("ðŸ”¹ Loading Faster R-CNN model (this may take a few seconds)...")
model = models.detection.fasterrcnn_resnet50_fpn(pretrained=True)
model.eval()
print("âœ… Model loaded successfully!")

# ----------------------------
# Open webcam (0 = default camera)
# ----------------------------
cap = cv2.VideoCapture(0)

if not cap.isOpened():
    print("âŒ Error: Could not open webcam.")
    exit()

fps = 30  # Approximate FPS for webcam (you can calibrate this)
distance_per_pixel = 0.05  # Approximate scale (m/pixel)
track_history = {}
max_history = 10

transform = transforms.Compose([
    transforms.ToTensor()
])

print("ðŸš€ Starting real-time vehicle detection... Press 'Q' to exit.")

while True:
    ret, frame = cap.read()
    if not ret:
        print("âš ï¸ Frame capture failed.")
        break

    # Convert image to tensor
    image_tensor = transform(frame).unsqueeze(0)

    with torch.no_grad():
        predictions = model(image_tensor)

    boxes = predictions[0]['boxes'].cpu().numpy()
    scores = predictions[0]['scores'].cpu().numpy()

    for i, box in enumerate(boxes):
        if scores[i] > 0.7:
            x1, y1, x2, y2 = map(int, box)
            cx = int((x1 + x2) / 2)
            cy = int((y1 + y2) / 2)

            vehicle_id = i
            if vehicle_id not in track_history:
                track_history[vehicle_id] = deque(maxlen=max_history)
            track_history[vehicle_id].append((cx, cy))

            if len(track_history[vehicle_id]) >= 2:
                (x_prev, y_prev) = track_history[vehicle_id][-2]
                distance = np.sqrt((cx - x_prev)**2 + (cy - y_prev)**2)
                speed_mps = distance * distance_per_pixel * fps
                speed_kmph = speed_mps * 3.6

                cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
                cv2.putText(frame, f"{speed_kmph:.1f} km/h", (x1, y1 - 10),
                            cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 255, 0), 2)
            else:
                cv2.rectangle(frame, (x1, y1), (x2, y2), (255, 0, 0), 2)

    cv2.imshow("Live Vehicle Speed Detection", frame)

    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
print("âœ… Detection stopped. Window closed.")
